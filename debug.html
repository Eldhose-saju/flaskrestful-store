<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.success {
            background: #28a745;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .status-item {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .status-ok { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Order Details Debug Tool</h1>
    <p>This tool helps diagnose issues with order details functionality.</p>

    <div class="debug-section">
        <h3>1. Server Connection Test</h3>
        <button class="test-button" onclick="testServerConnection()">Test Server Connection</button>
        <div id="server-test-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>2. Authentication Test</h3>
        <div>
            <input type="text" id="username" placeholder="Username" value="admin">
            <input type="password" id="password" placeholder="Password" value="admin123">
            <button class="test-button" onclick="testLogin()">Login</button>
            <button class="test-button danger" onclick="testLogout()">Logout</button>
        </div>
        <div id="auth-test-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>3. Orders API Test</h3>
        <button class="test-button" onclick="testOrdersAPI()">Test Orders List</button>
        <button class="test-button" onclick="testSpecificOrder()">Test Order Details</button>
        <input type="number" id="order-id" placeholder="Order ID" value="1">
        <div id="orders-test-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>4. Database Structure Test</h3>
        <button class="test-button" onclick="testDatabaseStructure()">Check Database</button>
        <div id="db-test-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>5. Create Test Order</h3>
        <button class="test-button success" onclick="createTestOrder()">Create Test Order</button>
        <div id="create-order-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>6. System Status</h3>
        <button class="test-button" onclick="checkSystemStatus()">Check Status</button>
        <div id="system-status" class="status-grid"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentUser = null;

        // API call function
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            console.log(`API Call: ${options.method || 'GET'} ${url}`);
            
            const config = {
                method: options.method || 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            const response = await fetch(url, config);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${data.message || 'Unknown error'}`);
            }
            
            return data;
        }

        async function testServerConnection() {
            const resultDiv = document.getElementById('server-test-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'Testing server connection...';
            
            try {
                const result = await apiCall('/test');
                resultDiv.className = 'result success';
                resultDiv.textContent = `✅ Server is running!\n\n${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Server connection failed:\n${error.message}\n\nMake sure Flask server is running on port 5000`;
            }
        }

        async function testLogin() {
            const resultDiv = document.getElementById('auth-test-result');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            resultDiv.className = 'result';
            resultDiv.textContent = 'Testing login...';
            
            try {
                const result = await apiCall('/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                currentUser = result.user;
                resultDiv.className = 'result success';
                resultDiv.textContent = `✅ Login successful!\n\n${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                currentUser = null;
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Login failed:\n${error.message}`;
            }
        }

        async function testLogout() {
            const resultDiv = document.getElementById('auth-test-result');
            
            try {
                await apiCall('/auth', { method: 'DELETE' });
                currentUser = null;
                resultDiv.className = 'result success';
                resultDiv.textContent = '✅ Logout successful!';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Logout failed:\n${error.message}`;
            }
        }

        async function testOrdersAPI() {
            const resultDiv = document.getElementById('orders-test-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'Testing orders API...';
            
            if (!currentUser) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ Please login first';
                return;
            }
            
            try {
                const orders = await apiCall('/orders');
                resultDiv.className = 'result success';
                resultDiv.textContent = `✅ Orders API working! Found ${orders.length} orders\n\n${JSON.stringify(orders, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Orders API failed:\n${error.message}`;
            }
        }

        async function testSpecificOrder() {
            const resultDiv = document.getElementById('orders-test-result');
            const orderId = document.getElementById('order-id').value;
            
            if (!orderId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ Please enter an Order ID';
                return;
            }
            
            if (!currentUser) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ Please login first';
                return;
            }
            
            resultDiv.className = 'result';
            resultDiv.textContent = `Testing order details for Order #${orderId}...`;
            
            try {
                const order = await apiCall(`/orders/${orderId}`);
                resultDiv.className = 'result success';
                resultDiv.textContent = `✅ Order details retrieved successfully!\n\nOrder #${orderId}:\n- Customer: ${order.username || 'N/A'}\n- Total: $${order.total_amount}\n- Status: ${order.status}\n- Items: ${order.items ? order.items.length : 0}\n\nFull details:\n${JSON.stringify(order, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Order details failed:\n${error.message}\n\nThis could mean:\n- Order doesn't exist\n- Permission denied\n- Database connection issue`;
            }
        }

        async function testDatabaseStructure() {
            const resultDiv = document.getElementById('db-test-result');
            resultDiv.className = 'result';
            resultDiv.textContent = 'Checking database structure...';
            
            try {
                // Test various endpoints to infer database structure
                const tests = [];
                
                // Test products
                try {
                    const products = await apiCall('/products');
                    tests.push(`✅ Products table: ${products.products ? products.products.length : products.length} products`);
                } catch (e) {
                    tests.push(`❌ Products table: ${e.message}`);
                }
                
                // Test users (if admin)
                if (currentUser && currentUser.is_admin) {
                    try {
                        const users = await apiCall('/users');
                        tests.push(`✅ Users table: ${users.length} users`);
                    } catch (e) {
                        tests.push(`❌ Users table: ${e.message}`);
                    }
                }
                
                // Test debug endpoint
                try {
                    const debug = await apiCall('/debug/users');
                    tests.push(`✅ Debug endpoint: Available`);
                } catch (e) {
                    tests.push(`❌ Debug endpoint: ${e.message}`);
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent = tests.join('\n');
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Database structure test failed:\n${error.message}`;
            }
        }

        async function createTestOrder() {
            const resultDiv = document.getElementById('create-order-result');
            
            if (!currentUser) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ Please login first';
                return;
            }
            
            if (currentUser.is_admin) {
                resultDiv.className = 'result warning';
                resultDiv.textContent = '⚠️ Admin users cannot create orders. Please login as a regular user.';
                return;
            }
            
            resultDiv.className = 'result';
            resultDiv.textContent = 'Creating test order...';
            
            try {
                // First, add some items to cart
                await apiCall('/cart', {
                    method: 'POST',
                    body: JSON.stringify({ product_id: 1, quantity: 1 })
                });
                
                // Then checkout
                const order = await apiCall('/orders', {
                    method: 'POST'
                });
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `✅ Test order created successfully!\n\nOrder #${order.order_id}\nTotal: ${order.total_amount}\n\nNow try viewing this order in the main application.`;
                
                // Update the order ID field for easy testing
                document.getElementById('order-id').value = order.order_id;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Test order creation failed:\n${error.message}`;
            }
        }

        async function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = 'Checking system status...';
            
            const checks = [
                { name: 'Server Connection', test: () => apiCall('/test') },
                { name: 'Authentication', test: () => currentUser ? Promise.resolve(currentUser) : Promise.reject(new Error('Not logged in')) },
                { name: 'Products API', test: () => apiCall('/products') },
                { name: 'Orders API', test: () => currentUser ? apiCall('/orders') : Promise.reject(new Error('Not logged in')) },
                { name: 'Cart API', test: () => currentUser && !currentUser.is_admin ? apiCall('/cart') : Promise.reject(new Error('Not applicable')) }
            ];
            
            const results = await Promise.allSettled(checks.map(async (check) => {
                try {
                    await check.test();
                    return { name: check.name, status: 'ok', message: 'Working' };
                } catch (error) {
                    return { name: check.name, status: 'error', message: error.message };
                }
            }));
            
            statusDiv.innerHTML = results.map(result => {
                const status = result.value;
                const statusClass = status.status === 'ok' ? 'status-ok' : 'status-error';
                return `<div class="status-item ${statusClass}"><strong>${status.name}</strong><br>${status.message}</div>`;
            }).join('');
        }

        // Auto-test on page load
        window.addEventListener('load', function() {
            console.log('Order Details Debug Tool loaded');
            testServerConnection();
        });
    </script>
</body>
</html>